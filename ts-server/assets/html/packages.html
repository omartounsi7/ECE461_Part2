<!DOCTYPE html>
<html>
<head>
  <title>Modules Registry</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      margin: 0 auto;
      max-width: 800px;
      padding: 20px;
    }
    h2 {
      margin: 1% 0;
      text-align: center;
    }
    p {
      margin: 1%;
    }
    .endpoint-div {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
      padding: 20px;
    }
    .submit-button {
      background-color: #4CAF50;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      padding: 10px;
      text-align: center;
      text-decoration: none;
      width: 100%;
    }

    .submit-button:focus {
      outline: 2px solid blue;
    }

    .submit-button.yes {
      font-size: 14px;
    }
    .submit-button:hover {
      background-color: #3e8e41;
    }
    .input-text {
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      height: 40px;
      margin-top: 10px;
      padding: 10px;
      width: 100%;
    }
    .input-file {
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      height: 40px;
      margin-top: 10px;
      padding: 10px;
      width: 100%;
    }
    label {
      display: block;
      font-weight: bold;
      margin-top: 10px;
    }
    .radio-label {
      display: inline-block;
      font-weight: normal;
      margin-right: 20px;
    }
    .radio-group label {
        margin-right: 10px;
    }
    .radio-group input[type="radio"] {
      margin-right: 5px;
    }
    /* New styles */
    #register-user form label,
    #register-user form input[type="text"],
    #register-user form input[type="password"] {
      width: 100%;
      margin-bottom: 10px;
    }
    #register-user form .radio-group label {
      margin-right: 10px;
    }
    #register-user form .radio-group input[type="radio"] {
      margin-right: 5px;
    }
  </style>
</head>
<body>
    <header>
        <h1>Modules Registry</h1>
        <nav>
            <button onclick="toggleDiv(0)">Package Search</button>
            <button onclick="toggleDiv(1)">Upload Module</button>
            <button onclick="toggleDiv(2)">Download Module</button>
            <button onclick="toggleDiv(3)">Reset Registry </button>
            <button onclick="toggleDiv(4)">Register User</button>
            <button onclick="toggleDiv(5)">Regex</button>
            <button onclick="toggleDiv(6)">Delete Account</button>
            <button onclick="toggleDiv(7)">Reset Registry</button>
            <button onclick="logOut()">Log Out</button>
        </nav>
    </header>
    <main>
      <div id="package-search" class="endpoint-div">
        <h2 style="margin-right: 20px;">Package Search</h2>
        <form>
          <label for="package-search-input">Enter search queries in the format: name,version
            <br> With a new line separating each query
            <br> Leave blank to query all packages
          </label>
          <textarea id="package-search-input" rows="5" cols="50" class="input-text"></textarea>
          <br>
          <button type="button" class="submit-button" onclick="submitPackageSearch()">Submit Search</button>
        </form>
      </div>

      <div id="regex-search" class="endpoint-div">
        <h2 style="margin-right: 20px;">Regex Search</h2>
        <form>
          <label for="regex-input">Enter a regex:</label>
          <input type="text" id="regex-input" class="input-text">
          <button type="button" class="submit-button" onclick="submitRegexSearch()">Submit Regex</button>
        </form>
      
        <h3 style="margin-left: 45px;">Results:</h3>
        <ul id="packages-list" style="margin-left: 10px; margin-top: 20px;">
        </ul>
      </div>
  
      <div id="upload-module" class="endpoint-div">
        <h2 style="margin-right: 20px;">Upload Module</h2>
        <form>
            <label for="module-upload-file">Upload your module as a zip file</label>
            <input type="file" id="module-upload-file" accept=".zip" class="input-file" />
            <label for="module-upload-url">OR provide a URL of your module</label>
            <input type="url" id="module-upload-url" class="input-text">
            <button type="button" class="submit-button" onclick="submitUploadModule()">Upload Module</button>
        </form>
    </div>

    <div id="package-download" class="endpoint-div">
      <h2 style="margin-right: 20px;">Package Download</h2>
      <form>
        <label for="package-id-input">Enter package ID:</label>
        <input type="text" id="package-id-input" class="input-text">
        <br>
        <button type="button" class="submit-button" onclick="downloadPackage()">Download</button>
      </form>
    </div>

      <div id="delete-module" class="endpoint-div">
        <h2 style="margin-right: 20px;">Delete Module</h2>
        <form>
          <label>
            <input type="radio" name="delete-by" value="name"> Delete by name
          </label>
          <label>
            <input type="radio" name="delete-by" value="id" checked> Delete by ID
          </label>
          <br>
          <label for="delete-module-input">Input name or ID:</label>
          <input type="text" id="delete-module-input" class="input-text" required>
          <button type="button" class="submit-button" onclick="submitDeleteModule()">Delete Module</button>
        </form>
      </div>
      
      
      <div id="register-user" class="endpoint-div">
        <h2 style="margin-right: 20px;">Register User</h2>
        <form>
            <label for="username-input">Enter a username:</label>
            <input type="text" id="username-input" size="40" class="input-text" required>
            <label for="password-input">Enter a password:</label>
            <input type="password" id="password-input" size="40" class="input-text" required>
            <span id="password-error" style="color: red; display: none;">Password must only contain alphanumeric characters.</span>
            <label for="admin-input">Is the user an admin?</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="admin-input" value="yes"> Yes
                </label>
                <label class="radio-label">
                    <input type="radio" name="admin-input" value="no" checked> No
                </label>
            </div>
            <button type="button" class="submit-button" onclick="submitRegisterUser()">Register User</button>
        </form>
      </div>

      <div id="delete-account" class="endpoint-div">
        <h2>Delete Account</h2>
        <p>Are you sure you want to delete your account?</p>
        <button type="button" class="submit-button yes" onclick="submitDeleteAccount(true)" style="margin-right: 20px; font-size: 15px;">Yes</button>
        <button type="button" class="submit-button no" onclick="submitDeleteAccount(false)" style="margin-left: 20px; font-size: 15px;">No</button>

      </div>

      <div id="reset-registry" class="endpoint-div">
        <h2>Reset Entire Registry</h2>
        <p>Are you sure you want to reset the entire registry?</p>
        <button type="button" class="submit-button yes" onclick="resetAccount(true)" style="margin-right: 20px; font-size: 15px;">Yes</button>
        <button type="button" class="submit-button no" onclick="resetAccount(false)" style="margin-left: 20px; font-size: 15px;">No</button>
      </div>
      

  </main>
  <script type="module" src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script>
      let packageSearchDiv = document.getElementById("package-search");
      let uploadModuleDiv = document.getElementById("upload-module");
      let deleteModuleDiv = document.getElementById("delete-module");
      let registerModuleDiv = document.getElementById("register-user");
      let regexDiv = document.getElementById("regex-search");
      let deleteUser = document.getElementById("delete-account");
      let resetRegistry = document.getElementById("reset-registry");
      let downloadPack = document.getElementById("package-download");
      let allDivs = [packageSearchDiv, uploadModuleDiv, downloadPack, deleteModuleDiv, registerModuleDiv, regexDiv, deleteUser, resetRegistry];
      
      function showDiv(div) {
          div.style.display = "flex";
      }
      function hideDiv(div) {
          div.style.display = "none";

      }
      function toggleDiv(index) {
          let d = allDivs[index];
          if(d.style.display === "none") {
              allDivs.forEach(item => { item !== d ? hideDiv(item) : showDiv(item); });
          } else {
              hideDiv(d);
          }
      }

      // init website
      function init() {
        // Hide all other divs
        allDivs.forEach(item => hideDiv(item));
      }
      init();

      // Finds out how to delete the module: by (name or id)
      function submitDeleteModuleBy() {
        let t = getSelectedDeleteType();
        return t;
      }

      function getSelectedDeleteType() {
          let radios = document.getElementsByName('delete-by');
          for (let i = 0; i < radios.length; i++) {
              if (radios[i].checked) {
                  return radios[i].value;
              }
          }
          return "";
      }

      async function handleResponseError(response, errorMessage) {
        if (response.status === 400) {
          if (errorMessage.includes("Expired Token")) {
            // Session needs to restart, prompt user to log out
            alert("Your session needs to be restarted. You will be logged out now.");
            // remove expired JWT authentication token from local storage
            localStorage.removeItem('authToken');
            // Redirect the user to the login page
            window.location.href = "/";
            return false
          } else if (errorMessage.includes("Invalid Token")) {
            renderErrorView(errorMessage, 'packages.html');
            return false
          } else if (errorMessage.includes("No Token Provided")) {
            renderErrorView(errorMessage, 'login.html');
            return false
          } else if (errorMessage.includes("SyntaxError:")) {
            renderErrorView(errorMessage, 'packages.html');
            return false
          } else {
            renderErrorView(errorMessage, 'packages.html');
          }
        } else if (response.status === 404) {
            // Error: Package does not exist
            renderErrorView(errorMessage, 'packages.html');
            return false
        } else if (response.status === 401) {
          // The user does not have the necessary admin privileges to reset the entire registry
          alert("Insufficient permissions to register a new user");
          return false;
        } else if (response.status === 409) {
          // Package already exists.
          renderErrorView(errorMessage, 'packages.html');
          return false
        } else if (response.status === 424) {
          // Package is not uploaded due to the disqualified rating.
          renderErrorView(errorMessage, 'packages.html');
          return false
        } else if (response.status === 402) {
          // Session needs to restart, prompt user to log out
          alert('Your session needs to be restarted. You will be logged out now.');
          // remove expired JWT authentication token from local storage
          localStorage.removeItem('authToken');
          // Redirect the user to the login page
          window.location.href = "/";
          return false
        } else if (response.status === 406 && errorMessage === true){
          // If the username is already taken, ask the user to reprompt for a new name
          alert('Username is already taken. Please choose a different username.');
          return false;
        }
        else {
          return true
        }
      }

      async function submitDeleteModule() {
        // Get the selected radio input
        var deleteTypeInput = submitDeleteModuleBy();

        // Determine whether to delete by ID or name
        let deleteById = (deleteTypeInput === "id");
       
        // Get the input for the module name or ID
        var moduleTextUser = document.getElementById("delete-module-input");

        // Check that all fields have been populated
        if (!moduleTextUser.value) {
          alert('Please fill in the field.');
          return;
        }

        if (deleteById) {
          // Delete module by ID
          const response = await fetch('/package/' + moduleTextUser.value, {
            method: 'DELETE',
            headers: {
              'X-Authorization': localStorage.getItem('authToken')
            } 
          });

            const data = await response.json();
            const errorMessage = data.message;

            const success_value = await handleResponseError(response, errorMessage);
            if(success_value) {
              alert('Successfully deleted module by ID!');
              // Reset the form field
              moduleTextUser.value = '';
              return;
            }
        } else {
          // Delete module by name
          const response = await fetch('/package/byName/' + moduleTextUser.value, {
            method: 'DELETE',
            headers: {
              'X-Authorization': localStorage.getItem('authToken')
            } 
          });

          const data = await response.json();
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage);

          if(success_value) {
            alert('Successfully deleted module by Name!');
            // Reset the form field
            moduleTextUser.value = '';
            return;
          }             
        }
      }

      async function submitRegisterUser() {
        // Get the form fields
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const adminInput = document.querySelector('input[name="admin-input"]:checked');

        // Check that all fields have been populated
        if (!usernameInput.value || !passwordInput.value || !adminInput.value) {
          alert('Please fill in all fields.');
          return;
        }

        // Call the API to check if the username is already taken
        const response = await fetch('/user/' + usernameInput.value, {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken')
          }
        });

        const data = await response.json();
        const errorMessage = data.message;

        const success_value = await handleResponseError(response, errorMessage);
        if (!success_value) {
          return;
        }
        // If the username is not already taken, register the user
        const userData = {
          username: usernameInput.value,
          password: passwordInput.value,
          admin: (adminInput.value === 'yes'),
        };

        // Check if current user trying to register another user has admin privileges
        const response_two = await fetch('/isAdmin', {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken'),
          },
        });

        const data1 = await response_two.json();
        const errorMessage2 = data1.message;

        const success_value2 = await handleResponseError(response_two, errorMessage2);
        if (!success_value2) {
          return;
        }

        if (response_two.status === 200) { 
          const registerResponse = await fetch('/new_user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken'),
            },
            body: JSON.stringify(userData)
          });

          const data3 = await registerResponse.json();
          const errorMessage3 = data3.message;

          const success_value3 = await handleResponseError(registerResponse, errorMessage3);
          if (!success_value3) {
            return;
          }

          if (registerResponse.status === 201) {
            // continue registering that user
            // Notify the user that the registration was successful
            alert('User registered successfully!');
            // Reset the form fields
            usernameInput.value = '';
            passwordInput.value = '';
            adminInput.checked = false;
          }
        }
      }
      
      /*
      function checkPasswordInput() {
        if (!/^[a-zA-Z0-9]*$/.test(passwordInput.value)) {
            passwordError.style.display = 'block';
        } else {
            passwordError.style.display = 'none';
        }
      }
      const passwordInput = document.getElementById('password-input');
      passwordInput.addEventListener('input', checkPasswordInput);
      */

      async function downloadPackage() {
        // Get the form fields
        const packageID = document.getElementById('package-id-input');

        // Check that all fields have been populated
        if (!packageID.value) {
          alert('Please provide a package ID');
          return;
        }

        const response = await fetch('/package/' + packageID.value, {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken')
          }
        });

        
        const body_contents = await response.json();
        const metadata = JSON.stringify(body_contents["metadata"]);
        const base64 = JSON.stringify(body_contents["data"]["Content"]);

        const success_value = await handleResponseError(response, body_contents);
        if (!success_value) {
          return;
        }
             
        // Decode base64 to binary data
        const base64WithoutQuotes = base64.replace(/"/g, '');
        alert(base64WithoutQuotes);
        const binaryStr = atob(base64WithoutQuotes);

        // Create a new JSZip instance
        const zip = new JSZip();

        // Add the binary data to the JSZip instance
        zip.file(metadata.Name, binaryStr, { binary: true });

        // Generate the zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });

        // Create a download link for the Blob object
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(zipBlob);
        downloadLink.download = metadata.filename;

        // Click the download link to trigger the file download
        downloadLink.click();

        // Clear the URL text field
        packageID.value = "";
      }


      // package search
      function submitPackageSearch() {
          // get input(s)
          // confirm input(s) are correct
          // send request
          // recv request
          // display results
      }

      // upload module
      async function submitUploadModule() {
      
        // get input(s)
        const file = document.getElementById("module-upload-file").files[0];
        const urlInput = document.getElementById("module-upload-url");
        const url = urlInput.value;

        if (!file && !url) {
          alert('Either Content or URL must be provided');
          return;
        } else if (file && url) {
          alert('Both Content and URL cannot be provided at the same time.');
          return;
        }
    
        if (file) {
          // Reads the content of the package, removes the .git directory, and encodes the compressed zip to base64
          const x = new JSZip();
          const base64 = await JSZip.loadAsync(file).then(zip => {
            zip.remove(".git");
            return zip.generateAsync({ type: "base64" });
          });

          const response = await fetch('/package/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken')
            },
            body: JSON.stringify({"Content": base64})
          });


          const data = await response.json();
          alert(data.status)
          const errorMessage = data.message;
          alert(errorMessage)

          const success_value = await handleResponseError(response, errorMessage);
          if (!success_value) {
            return;
          }
          alert('Success. Check the ID in the returned metadata for the official ID');
          // Clear the URL text field
          url.value = "";
          
        } else {
          // User entered a URL
          const response = await fetch('/package/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken')
            },
            body: JSON.stringify({"URL": url})
          });

          const data = await response.json();
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage);
          if (!success_value) {
            return;
          }
          alert('Success. Check the ID in the returned metadata for the official ID');
          // Clear the URL text field
          url.value = "";
        }
      }

      // executes the JavaScript within the <script> tags in the fetched error.html file.
      function executeScripts(element) {
        // Get all script tags in the element
        const scripts = element.querySelectorAll('script');

        // Execute each script in the element
        for (let script of scripts) {
          const scriptContent = script.innerHTML;
          const newScript = document.createElement('script');
          newScript.innerHTML = scriptContent;
          document.body.appendChild(newScript);
        }
      }

      async function renderErrorView(errorMessage, backUrl) {
        const errorHtmlResponse = await fetch('/error.html');
        const errorHtml = await errorHtmlResponse.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(errorHtml, 'text/html');
        doc.querySelector('#error-message').setAttribute('data-message', errorMessage);
        doc.querySelector('#error-message').innerHTML = errorMessage;

        // Set the value of the "data-url" attribute on the #back-url element
        const backUrlElement = doc.querySelector('#back-url');
        backUrlElement.setAttribute('data-url', backUrl);

        // Replace the current document's head with the fetched head
        document.head.innerHTML = doc.head.innerHTML;
        document.body.innerHTML = doc.documentElement.innerHTML;
        // Execute scripts in the fetched error.html
        executeScripts(doc);
      }

      async function submitRegexSearch() {
        let regex = document.getElementById('regex-input').value.trim();

        // check if regex was provided
        if (regex === '') {
          alert('Please enter a regex.');
          return;
        }

        const response = await fetch('/package/byRegEx', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Authorization': localStorage.getItem('authToken')
          },
          body: JSON.stringify({"RegEx": regex})
        });

        const packages = await response.json();
        const errorMessage = packages.message;

        const success_value = await handleResponseError(response, errorMessage)
        if (!success_value) {
          return;
        }
         
        const packagesList = document.getElementById('packages-list');
        packagesList.innerHTML = '';

        packages.forEach(pkg => {
          const li = document.createElement('li');
          li.textContent = `Name: ${pkg.Name} –– Version: (${pkg.Version})`;
          packagesList.appendChild(li);
        });
      }
      
      function logOut() {
        // Redirect the user to the login page
        window.location.href = "/";
      }

      async function resetAccount(confirmed) {
        if (confirmed) {
          const response = await fetch('/reset', {
            method: 'DELETE',
            headers: {
              'X-Authorization': localStorage.getItem('authToken')
            }
          });

          const data = await response.json();
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage)
          if (!success_value) {
            return;
          }

          // Handles successful response
          alert('Registry successfully reset.');
          window.location.href = '/';
        } else {
          // Redirect the user to the main page if user presses "No"
          window.location.href = 'packages.html';
        }
      }

      async function submitDeleteAccount(confirmed) {
        if (confirmed) {
          const deleteResponse = await fetch('/user', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken')
            }
          });

          const data = await deleteResponse.json();
          const errorMessage = data.message;

          const success_value = await handleResponseError(deleteResponse, errorMessage)
          if (!success_value) {
            return;
          }
          // Handle success response
          alert('Account successfully deleted.');
          localStorage.removeItem('authToken');
          window.location.href = '/';
        } else {
          // Redirect the user to the main page if user presses "No"
          window.location.href = 'packages.html';
        }
      }
  </script>
</body>
</html>