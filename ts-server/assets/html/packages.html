<!DOCTYPE html>
<html>
<head>
  <title>Modules Registry</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      margin: 0 auto;
      max-width: 800px;
      padding: 20px;
    }
    h2 {
      margin: 1% 0;
      text-align: center;
    }
    p {
      margin: 1%;
    }
    .endpoint-div {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
      padding: 20px;
    }
    .submit-button {
      background-color: #4CAF50;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      padding: 10px;
      text-align: center;
      text-decoration: none;
      width: 100%;
    }

    .submit-button:focus {
      outline: 2px solid blue;
    }

    .submit-button.yes {
      font-size: 14px;
    }
    .submit-button:hover {
      background-color: #3e8e41;
    }
    .input-text {
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      height: 40px;
      margin-top: 10px;
      padding: 10px;
      width: 100%;
    }
    .input-file {
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      height: 40px;
      margin-top: 10px;
      padding: 10px;
      width: 100%;
    }
    label {
      display: block;
      font-weight: bold;
      margin-top: 10px;
    }
    .radio-label {
      display: inline-block;
      font-weight: normal;
      margin-right: 20px;
    }
    .radio-group label {
        margin-right: 10px;
    }
    .radio-group input[type="radio"] {
      margin-right: 5px;
    }

    #register-user form label,
    #register-user form input[type="text"],
    #register-user form input[type="password"] {
      width: 100%;
      margin-bottom: 10px;
    }
    #register-user form .radio-group label {
      margin-right: 10px;
    }
    #register-user form .radio-group input[type="radio"] {
      margin-right: 5px;
    }
  </style>
</head>
<body>
    <header>
        <h1>Modules Registry</h1>
        <nav>
            <button onclick="toggleDiv(0)">Package Search</button>
            <button onclick="toggleDiv(1)">Upload Module</button>
            <button onclick="toggleDiv(2)">Download Module</button>
            <button onclick="toggleDiv(3)">Update Module</button>
            <button onclick="toggleDiv(4)">Module History</button>
            <button onclick="toggleDiv(5)">Delete Module </button>
            <button onclick="toggleDiv(6)">Register User</button>
            <button onclick="toggleDiv(7)">Regex</button>
            <button onclick="toggleDiv(8)">Rate Module</button>
            <button onclick="toggleDiv(9)">Delete Account</button>
            <button onclick="toggleDiv(10)">Reset Registry</button>
            <button onclick="logOut()">Log Out</button>
        </nav>
    </header>
    <main>
      
      <div id="package-search" class="endpoint-div">
        <h2 style="margin-right: 20px;">Package Search</h2>
        <form>
          <label for="package-search-input">Enter search queries in the format: name,version
            <br> With a new line separating each query
            <br> Provide * to query all packages
          </label>
          <textarea id="package-search-input" rows="5" cols="50" class="input-text"></textarea>
          <br>
          <label for="pagination-input">Enter pagination:</label>
          <input type="text" id="pagination-input">
          <br>
          <button type="button" class="submit-button" onclick="submitPackageSearch()">Submit Search</button>
          <div id="packages-list"></div>
        </form>

      </div>
    
      <div id="regex-search" class="endpoint-div">
        <h2 style="margin-right: 20px;">Regex Search</h2>
        <form>
          <label for="regex-input">Enter a regex:</label>
          <input type="text" id="regex-input" class="input-text">
          <button type="button" class="submit-button" onclick="submitRegexSearch()">Submit Regex</button>
        </form>
      
        <h3 style="margin-left: 45px;">Results:</h3>
        <ul id="packages-list" style="margin-left: 10px; margin-top: 20px;">
        </ul>
      </div>
  
      <div id="upload-module" class="endpoint-div">
          <h2 style="margin-right: 20px;">Upload Module</h2>
          <form>
              <label for="module-upload-file">Upload your module as a zip file</label>
              <input type="file" id="module-upload-file" accept=".zip" class="input-file" />
              <label for="module-upload-url">OR provide a URL of your module</label>
              <input type="url" id="module-upload-url" class="input-text">
              <button type="button" class="submit-button" onclick="submitUploadModule()">Upload Module</button>
              <div id="id-display" style="display: none;"></div>
          </form>
      </div>

      <div id="update-module" class="endpoint-div">
        <h2 style="margin-right: 20px;">Update Module</h2>
        <form>
          <label for="package-id">Enter exisiting package ID:</label>
          <input type="text" id="package-id" class="input-text">
          <br>
          <label for="upload-file">Upload new module as a zip file:</label>
          <input type="file" id="upload-file" accept=".zip" class="input-file" />
          <br>
          <label for="upload-url">Or provide a URL of new module:</label>
          <input type="url" id="upload-url" class="input-text">
          <br>
          <button type="button" class="submit-button" onclick="updateModule()">Update Module</button>
        </form>
      </div>

      <div id="rate-module" class="endpoint-div">
        <h2 style="margin-right: 20px;">Rate Module</h2>
        <form>
          <label for="package-rate-id">Enter package ID of module you want rated:</label>
          <input type="text" id="package-rate-id" class="input-text">
          <br>
          <button type="button" class="submit-button" onclick="rateModules()">Update Module</button>
          <div id="ratings"></div>
        </form>
      </div>

      <div id="log-history" class="endpoint-div">
        <h2 style="margin-right: 20px;">Package History</h2>
        <form>
          <label for="package-name-input">Enter package name:</label>
          <input type="text" id="package-name-input" class="input-text">
          <button type="button" class="submit-button" onclick="getPackageHistory()">Get History</button>
          <div id="package-history"></div>
        </form>
      </div>
      
      <div id="package-download" class="endpoint-div">
        <h2 style="margin-right: 20px;">Package Download</h2>
        <form>
          <label for="package-id-input">Enter package ID:</label>
          <input type="text" id="package-id-input" class="input-text">
          <button type="button" class="submit-button" onclick="downloadPackage()">Download Module</button>
        </form>
      </div>

      <div id="delete-module" class="endpoint-div">
        <h2 style="margin-right: 20px;">Delete Module</h2>
        <form>
          <label>
            <input type="radio" name="delete-by" value="name"> Delete by name
          </label>
          <label>
            <input type="radio" name="delete-by" value="id" checked> Delete by ID
          </label>
          <br>
          <label for="delete-module-input">Input name or ID:</label>
          <input type="text" id="delete-module-input" class="input-text" required>
          <button type="button" class="submit-button" onclick="submitDeleteModule()">Delete Module</button>
        </form>
      </div>
      
      <div id="register-user" class="endpoint-div">
        <h2 style="margin-right: 20px;">Register User</h2>
        <form>
            <label for="username-input">Enter a username:</label>
            <input type="text" id="username-input" size="40" class="input-text" required>
            <label for="password-input">Enter a password:</label>
            <input type="password" id="password-input" size="40" class="input-text" required>
            <span id="password-error" style="color: red; display: none;">Password must only contain alphanumeric characters.</span>
            <label for="admin-input">Is the user an admin?</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="admin-input" value="yes"> Yes
                </label>
                <label class="radio-label">
                    <input type="radio" name="admin-input" value="no" checked> No
                </label>
            </div>
            <button type="button" class="submit-button" onclick="submitRegisterUser()">Register User</button>
        </form>
      </div>

      <div id="delete-account" class="endpoint-div">
        <h2>Delete Account</h2>
        <p>Are you sure you want to delete your account?</p>
        <button type="button" class="submit-button yes" onclick="submitDeleteAccount(true)" style="margin-right: 20px; font-size: 15px;">Yes</button>
        <button type="button" class="submit-button no" onclick="submitDeleteAccount(false)" style="margin-left: 20px; font-size: 15px;">No</button>

      </div>

      <div id="reset-registry" class="endpoint-div">
        <h2>Reset Entire Registry</h2>
        <p>Are you sure you want to reset the entire registry?</p>
        <button type="button" class="submit-button yes" onclick="resetAccount(true)" style="margin-right: 20px; font-size: 15px;">Yes</button>
        <button type="button" class="submit-button no" onclick="resetAccount(false)" style="margin-left: 20px; font-size: 15px;">No</button>
      </div>
      



  </main>
  <script type="module" src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script>
      let packageSearchDiv = document.getElementById("package-search");
      let uploadModuleDiv = document.getElementById("upload-module");
      let updateModuleDiv = document.getElementById("update-module");
      let deleteModuleDiv = document.getElementById("delete-module");
      let registerModuleDiv = document.getElementById("register-user");
      let regexDiv = document.getElementById("regex-search");
      let deleteUser = document.getElementById("delete-account");
      let resetRegistry = document.getElementById("reset-registry");
      let downloadPack = document.getElementById("package-download");
      let logHistory = document.getElementById("log-history");
      let rateModule = document.getElementById("rate-module");
      let allDivs = [packageSearchDiv, uploadModuleDiv, downloadPack, updateModuleDiv, logHistory, deleteModuleDiv, registerModuleDiv, regexDiv,rateModule, deleteUser, resetRegistry];
      
      function showDiv(div) {
          div.style.display = "flex";
      }
      function hideDiv(div) {
          div.style.display = "none";

      }
      function toggleDiv(index) {
          let d = allDivs[index];
          if(d.style.display === "none") {
              allDivs.forEach(item => { item !== d ? hideDiv(item) : showDiv(item); });
          } else {
              hideDiv(d);
          }
      }

      // init website
      function init() {
        // Hide all other divs
        allDivs.forEach(item => hideDiv(item));
      }
      init();

      // Finds out how to delete the module: by (name or id)
      function submitDeleteModuleBy() {
        let t = getSelectedDeleteType();
        return t;
      }

      function getSelectedDeleteType() {
          let radios = document.getElementsByName('delete-by');
          for (let i = 0; i < radios.length; i++) {
              if (radios[i].checked) {
                  return radios[i].value;
              }
          }
          return "";
      }

      async function handleResponseError(response, errorMessage) {
        if (response.status === 400) {
          if (errorMessage.includes("Expired Token")) {
            // Session needs to restart, prompt user to log out
            alert("Your session needs to be restarted. You will be logged out now.");
            // remove expired JWT authentication token from local storage
            localStorage.removeItem('authToken');
            // Redirect the user to the login page
            window.location.href = "/";
            return false
          } else if (errorMessage.includes("Invalid Token")) {
            renderErrorView(errorMessage, 'packages.html');
            return false
          } else if (errorMessage.includes("No Token Provided")) {
            renderErrorView(errorMessage, 'login.html');
            return false
          } else if (errorMessage.includes("SyntaxError:")) {
            renderErrorView(errorMessage, 'packages.html');
            return false
          } else {
            renderErrorView(errorMessage, 'packages.html');
          }
        } else if (response.status === 404) {
            // Error: Package does not exist
            renderErrorView(errorMessage, 'packages.html');
            return false
        } else if (response.status === 401) {
          // The user does not have the necessary admin privileges to reset the entire registry
          alert("Insufficient permissions to register a new user");
          return false;
        } else if (response.status === 409) {
          // Package already exists.
          renderErrorView(errorMessage, 'packages.html');
          return false
        } else if (response.status === 424) {
          // Package is not uploaded due to the disqualified rating.
          renderErrorView(errorMessage, 'packages.html');
          return false
        } else if (response.status === 402) {
          // Session needs to restart, prompt user to log out
          alert('Your session needs to be restarted. You will be logged out now.');
          // remove expired JWT authentication token from local storage
          localStorage.removeItem('authToken');
          // Redirect the user to the login page
          window.location.href = "/";
          return false
        } else if (response.status === 406 && errorMessage === true){
          // If the username is already taken, ask the user to reprompt for a new name
          alert('Username is already taken. Please choose a different username.');
          return false;
        } else if (response.status === 500){
          // The package rating system choked on at least one of the metrics for rate
          alert('The package rating system choked on at least one of the metrics.');
          return false;
        }
        else {
          return true
        }
      }

      async function submitDeleteModule() {
        // Get the selected radio input
        var deleteTypeInput = submitDeleteModuleBy();

        // Determine whether to delete by ID or name
        let deleteById = (deleteTypeInput === "id");
       
        // Get the input for the module name or ID
        var moduleTextUser = document.getElementById("delete-module-input");

        // Check that all fields have been populated
        if (!moduleTextUser.value) {
          alert('Please fill in the field.');
          return;
        }

        if (deleteById) {
          // Delete module by ID

          // Check that package ID only contains numbers
          const filter = /^[0-9]+$/;
          if (!filter.test(moduleTextUser.value)) {
            alert('Package ID must contain only numbers');
            return;
          }

          // Package ID cannot be 0
          if (moduleTextUser.value === '0') {
            alert('Package ID cannot be 0');
            return;
          }

          const response = await fetch('/package/' + moduleTextUser.value, {
            method: 'DELETE',
            headers: {
              'X-Authorization': localStorage.getItem('authToken')
            } 
          });

            const data = await response.json();
            const errorMessage = data.message;

            const success_value = await handleResponseError(response, errorMessage);
            if(success_value) {
              alert('Successfully deleted module by ID!');
              // Reset the form field
              moduleTextUser.value = '';
              return;
            }
        } else {
          // Delete module by name
          const response = await fetch('/package/byName/' + moduleTextUser.value, {
            method: 'DELETE',
            headers: {
              'X-Authorization': localStorage.getItem('authToken')
            } 
          });

          const data = await response.json();
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage);

          if(success_value) {
            alert('Successfully deleted module by Name!');
            // Reset the form field
            moduleTextUser.value = '';
            return;
          }             
        }
      }

      async function submitRegisterUser() {
        // Get the form fields
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const adminInput = document.querySelector('input[name="admin-input"]:checked');

        // Check that all fields have been populated
        if (!usernameInput.value || !passwordInput.value || !adminInput.value) {
          alert('Please fill in all fields.');
          return;
        }

        // Call the API to check if the username is already taken
        const response = await fetch('/user/' + usernameInput.value, {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken')
          }
        });

        const data = await response.json();
        const errorMessage = data.message;

        const success_value = await handleResponseError(response, errorMessage);
        if (!success_value) {
          return;
        }
        // If the username is not already taken, register the user
        const userData = {
          username: usernameInput.value,
          password: passwordInput.value,
          admin: (adminInput.value === 'yes'),
        };

        // Check if current user trying to register another user has admin privileges
        const response_two = await fetch('/isAdmin', {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken'),
          },
        });

        const data1 = await response_two.json();
        const errorMessage2 = data1.message;

        const success_value2 = await handleResponseError(response_two, errorMessage2);
        if (!success_value2) {
          return;
        }

        if (response_two.status === 200) { 
          const registerResponse = await fetch('/new_user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken'),
            },
            body: JSON.stringify(userData)
          });

          const data3 = await registerResponse.json();
          const errorMessage3 = data3.message;

          const success_value3 = await handleResponseError(registerResponse, errorMessage3);
          if (!success_value3) {
            return;
          }

          if (registerResponse.status === 201) {
            // continue registering that user
            // Notify the user that the registration was successful
            alert('User registered successfully!');
            // Reset the form fields
            usernameInput.value = '';
            passwordInput.value = '';
            adminInput.checked = false;
          }
        }
      }
      
      async function downloadPackage() {
        // Get the form fields
        const packageID = document.getElementById('package-id-input');

        // Check that all fields have been populated
        if (!packageID.value) {
          alert('Please provide a package ID');
          return;
        }

        // Package ID cannot be 0
        if (packageID.value === '0') {
          alert('Package ID cannot be 0');
          return;
        }

        // Check that package ID only contains numbers
        const filter = /^[0-9]+$/;
        if (!filter.test(packageID.value)) {
          alert('Package ID must contain only numbers');
          return;
        }

        const response = await fetch('/package/' + packageID.value, {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken')
          }
        });

        // Retrieve response data
        const data = await response.json();

        // Error Message only defined when error occured
        const errorMessage = data.message;

        const success_value = await handleResponseError(response, errorMessage);
        if (!success_value) {
          return;
        }

        // Extract the properties from json object
        const metadata = data["metadata"];
        const base64 = data["data"]["Content"];
        const name = data["metadata"]["Name"];

        // Create a new download link element
        const downloadLink = document.createElement('a');
        downloadLink.setAttribute('href', `data:application/zip;base64,${base64}`);
        downloadLink.setAttribute('download', name);

        // Hide the download link element
        downloadLink.style.display = 'none';

        // Append the download link element to the document body
        document.body.appendChild(downloadLink);

        // Click the download link to trigger the download
        downloadLink.click();

        // Remove the download link from the document body
        document.body.removeChild(downloadLink);
      }

      async function updateModule() {
        // Get the form fields
        const packageID = document.getElementById('package-id');

        // Check that all fields have been populated
        if (!packageID.value) {
          alert('Please provide a package ID');
          return;
        }

        // Package ID cannot be 0
        if (packageID.value === '0') {
          alert('Package ID cannot be 0');
          return;
        }

        // Check that package ID only contains numbers
        const filter = /^[0-9]+$/;
        if (!filter.test(packageID.value)) {
          alert('Package ID must contain only numbers');
          return;
        }

        // get input(s)
        const file = document.getElementById("upload-file").files[0];
        const urlInput = document.getElementById("upload-url");
        const url = urlInput.value;

        if (!file && !url) {
          alert('Either Content or URL must be provided');
          return;
        } else if (file && url) {
          alert('Both Content and URL cannot be provided at the same time.');
          return;
        }

        // Call the server to retrieve the metadata for the respective package ID
        const response = await fetch('/packageMeta/' + packageID.value, {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken')
          }
        });

        const data = await response.json();
        // Extract values from Metadata
        const name = data.Name;
        const version = data.Version;
        const ID = data.ID;

        // Error Message only defined when error occured
        const errorMessage = data.message;

        const success_value = await handleResponseError(response, errorMessage);
        if (!success_value) {
          return;
        }

        // Needs to adhere to the Package schema
        let packageData;

        if (file) {
          // Reads the content of the package, removes the .git directory, and encodes the compressed zip to base64
          const base64 = await JSZip.loadAsync(file).then(zip => {
            zip.remove(".git");
            return zip.generateAsync({ type: "base64" });
          });

          packageData = {
            "metadata": {
              "Name": name,
              "Version": version,
              "ID": ID
            },
            "data": {
              "Content": base64
            }
          };
        }

        if (url) {
          packageData = {
            "metadata": {
              "Name": name,
              "Version": version,
              "ID": ID
            },
            "data": {
              "URL": url
            }
          };
        }

        const response2 = await fetch('/package/' + packageID.value, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Authorization': localStorage.getItem('authToken')
          },
          body: JSON.stringify(packageData)
        });

        const data2 = await response2.json();
        const errorMessage2 = data2.message;

        const success_value_2 = await handleResponseError(response2, errorMessage2);
        if (!success_value_2) {
          return;
        }
        alert('Success. Package Contents of specified package are updated.');
        // Clear all text fields
        urlInput.value = "";
        packageID.value = "";
      }

      async function rateModules() {
        // Get the form fields
        const packageID = document.getElementById('package-rate-id');

        // Check that all fields have been populated
        if (!packageID.value) {
          alert('Please provide a package ID');
          return;
        }

        // Package ID cannot be 0
        if (packageID.value === '0') {
          alert('Package ID cannot be 0');
          return;
        }

        // Check that package ID only contains numbers
        const filter = /^[0-9]+$/;
        if (!filter.test(packageID.value)) {
          alert('Package ID must contain only numbers');
          return;
        }

        const response = await fetch('/package/' + packageID.value + "/rate", {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken')
          }
        });

        // data received from server
        const ratings = await response.json();

        // Get the HTML element to display the results
        const resultDiv = document.getElementById('package-history');

        // Error Message only defined when error occurs
        const errorMessage = ratings.message;

        const success_value = await handleResponseError(response, errorMessage);
        if (!success_value) {
          return;
        }

        // Access the HTML element to display the ratings
        const ratingsDiv = document.getElementById('ratings');
        // Clear any previous results
        ratingsDiv.innerHTML = '';

        // Will store the metric values
        const ratingString = `
          <table>
            <br>
            <tr>
              <td>BusFactor</td>
              <td>${ratings.BusFactor}</td>
            </tr>
            <tr>
              <td>Correctness</td>
              <td>${ratings.Correctness}</td>
            </tr>
            <tr>
              <td>RampUp</td>
              <td>${ratings.RampUp}</td>
            </tr>
            <tr>
              <td>ResponsiveMaintainer  </td>
              <td>${ratings.ResponsiveMaintainer}</td>
            </tr>
            <tr>
              <td>LicenseScore</td>
              <td>${ratings.LicenseScore}</td>
            </tr>
            <tr>
              <td>GoodPinningPractice</td>
              <td>${ratings.GoodPinningPractice}</td>
            </tr>
            <tr>
              <td>PullRequest</td>
              <td>${ratings.PullRequest}</td>
            </tr>
            <tr>
              <td>NetScore</td>
              <td>${ratings.NetScore}</td>
            </tr>
          </table>
        `;

        // Set the content of the ratings HTML element to the rating string
        ratingsDiv.innerHTML = ratingString;
      }

      async function getPackageHistory() {
        // Get the form fields
        const packageName = document.getElementById('package-name-input');

        if (!packageName.value) {
          alert('Please provide a package name');
          return;
        }

        const response = await fetch('/package/byName/' + packageName.value, {
          method: 'GET',
          headers: {
            'X-Authorization': localStorage.getItem('authToken')
          }
        });

        const data = await response.json();
        
        // Get the HTML element to display the results
        const resultDiv = document.getElementById('package-history');

        // Error Message only defined when error occurs
        const errorMessage = data.message;

        const success_value = await handleResponseError(response, errorMessage);
        if (!success_value) {
          return;
        }

        // Clear any previous results
        resultDiv.innerHTML = '';

        // Loop through each element in the data list and create an HTML element for it
        for (const element of data) {
          const name = element.PackageMetadata.Name;
          const version = element.PackageMetadata.Version;
          const ID = element.PackageMetadata.ID;
          const date = element.Date;
          const user = element.User.name;
          const admin = element.User.isAdmin;
          const action = element.Action;

          const listItem = document.createElement('div');
          listItem.innerHTML = `
            <br>
            <strong>Package Name:</strong> ${name}<br>
            <strong>Version:</strong> ${version}<br>
            <strong>Package ID:</strong> ${ID}<br>
            <strong>Date:</strong> ${date}<br>
            <strong>User:</strong> ${user}<br>
            <strong>Is Admin:</strong> ${admin}<br>
            <strong>Action:</strong> ${action}<br>
            <hr>
          `;
          resultDiv.appendChild(listItem);
        }
      }

      // package search
      async function submitPackageSearch() {
          // Read the value at the package-search-input element
          const packageSearchInput = document.getElementById("package-search-input");
          const searchQueries = packageSearchInput.value;

          // Read the value at the package-search-input element
          const paginationInput = document.getElementById("pagination-input");
          // Provide this for pagination. If not provided, returns the first page of results.
          let offset = paginationInput.value;

          if (!searchQueries) {
            alert('Provide some input in the text field');
            return;
          }
        
          // Provide this for pagination. If not provided, returns the first page of results.
          if (offset === "0" || !offset){
            offset = 1
          }

          // Splitting the input into an array of strings (name, version)
          let values = searchQueries.split("\n");

          let objectFormatList = []
          // Iterating over each query by user
          for(let i = 0; i < values.length; i++) {
            // Splitting (name, version)
            let [name, version] = values[i].split(", ");
            let objectFormat = {
                "Version": version,
                "Name": name
            }
            objectFormatList.push(objectFormat)
          }

          // Calls the package post api endpoint
          const response = await fetch('/packages?offset=' + offset, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken'),
            }
          });

          // reads the offset header from the response
          const offsetHeader = response.headers.get('offset');
          const offsetReceived = Number(offsetHeader);
          console.log(offsetReceived)

          // retrieves the return object
          const data = await response.json();
          console.log(data)
          // Error Message only defined when error occured
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage);
          if (!success_value) {
            return;
          }

          // HTML-element that will show the resulting packages to the user
          const packagesOutput = document.getElementById("packages-list");

          // creates each package HTML element in json object received by server
          const packageBoxesHTML = data.map(package => `
            <div style="border: 1px solid #ccc; border-radius: 5px; margin: 10px; padding: 10px; box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.2); transform: translateZ(0);">
              <p><strong>Version:</strong> ${package.Version}</p>
              <p><strong>Name:</strong> ${package.Name}</p>
              <p><strong>ID:</strong> ${package.ID}</p>
              <p><strong>Popularity:</strong> ${popularityModule(ID)}</p>
            </div>
          `).join('');
          packagesOutput.innerHTML = packageBoxesHTML;

          // alerts the user of the successful retrieval of their packages
          alert("These are all the packages provided given the pagination constraint");
      }

      async function popularityModule(ID) {
        const response2 = await fetch('/popularity/' + ID, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken'),
            }
          });
          
          // retrieves the return object
          const data2 = await response2.json();
          // Error Message only defined when error occured
          const errorMessage2 = data2.message;

          const success_value2 = await handleResponseError(response2, errorMessage2);
          if (!success_value) {
            return;
          }

          // return the download count for that modules
          return data2.download_count;
      }

      // upload module
      async function submitUploadModule() {
      
        // get input(s)
        const idDisplay = document.getElementById("id-display");
        idDisplay.style.display = 'none';
        const file = document.getElementById("module-upload-file").files[0];
        const urlInput = document.getElementById("module-upload-url");
        const url = urlInput.value;

        if (!file && !url) {
          alert('Either Content or URL must be provided');
          return;
        } else if (file && url) {
          alert('Both Content and URL cannot be provided at the same time.');
          return;
        }
    
        if (file) {
          // Reads the content of the package, removes the .git directory, and encodes the compressed zip to base64
          const base64 = await JSZip.loadAsync(file).then(zip => {
            zip.remove(".git");
            return zip.generateAsync({ type: "base64" });
          });

          // Calls the package post api endpoint
          const response = await fetch('/package/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken')
            },
            body: JSON.stringify({"Content": base64})
          });


          // retrieves the return object
          const data = await response.json();
          // Error Message only defined when error occured
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage);
          if (!success_value) {
            return;
          }

          // Extract values from Metadata
          const ID = data["metadata"]["ID"];
          idDisplay.innerHTML = `Success. The ID for the uploaded package is ${ID}.`;
          idDisplay.style.display = 'block';
          // Clear the URL text field
          url.value = "";          
        } else {
          // User entered a URL
          const response = await fetch('/package/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken')
            },
            body: JSON.stringify({"URL": url})
          });

          const data = await response.json();
          // Error Message only defined when error occured
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage);
          if (!success_value) {
            return;
          }

          // Extract values from Metadata
          const ID = data["metadata"]["ID"];
          alert("Success")
          idDisplay.innerHTML = `Success. The ID for the uploaded package is ${ID}.`;
          idDisplay.style.display = 'block';
          // Clear the URL text field
          url.value = "";      
        }
      }

      // executes the JavaScript within the <script> tags in the fetched error.html file.
      function executeScripts(element) {
        // Get all script tags in the element
        const scripts = element.querySelectorAll('script');

        // Execute each script in the element
        for (let script of scripts) {
          const scriptContent = script.innerHTML;
          const newScript = document.createElement('script');
          newScript.innerHTML = scriptContent;
          document.body.appendChild(newScript);
        }
      }

      async function renderErrorView(errorMessage, backUrl) {
        const errorHtmlResponse = await fetch('/error.html');
        const errorHtml = await errorHtmlResponse.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(errorHtml, 'text/html');
        doc.querySelector('#error-message').setAttribute('data-message', errorMessage);
        doc.querySelector('#error-message').innerHTML = errorMessage;

        // Set the value of the "data-url" attribute on the #back-url element
        const backUrlElement = doc.querySelector('#back-url');
        backUrlElement.setAttribute('data-url', backUrl);

        // Replace the current document's head with the fetched head
        document.head.innerHTML = doc.head.innerHTML;
        document.body.innerHTML = doc.documentElement.innerHTML;
        // Execute scripts in the fetched error.html
        executeScripts(doc);
      }

      async function submitRegexSearch() {
        let regex = document.getElementById('regex-input').value.trim();

        // check if regex was provided
        if (regex === '') {
          alert('Please enter a regex.');
          return;
        }

        const response = await fetch('/package/byRegEx', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Authorization': localStorage.getItem('authToken')
          },
          body: JSON.stringify({"RegEx": regex})
        });

        const packages = await response.json();
        const errorMessage = packages.message;

        const success_value = await handleResponseError(response, errorMessage)
        if (!success_value) {
          return;
        }
         
        const packagesList = document.getElementById('packages-list');
        packagesList.innerHTML = '';

        packages.forEach(pkg => {
          const li = document.createElement('li');
          li.textContent = `Name: ${pkg.Name} –– Version: (${pkg.Version})`;
          packagesList.appendChild(li);
        });
      }
      
      function logOut() {
        // Redirect the user to the login page
        window.location.href = "/";
      }

      async function resetAccount(confirmed) {
        if (confirmed) {
          const response = await fetch('/reset', {
            method: 'DELETE',
            headers: {
              'X-Authorization': localStorage.getItem('authToken')
            }
          });

          const data = await response.json();
          const errorMessage = data.message;

          const success_value = await handleResponseError(response, errorMessage)
          if (!success_value) {
            return;
          }

          // Handles successful response
          alert('Registry successfully reset.');
          window.location.href = '/';
        } else {
          // Redirect the user to the main page if user presses "No"
          window.location.href = 'packages.html';
        }
      }

      async function submitDeleteAccount(confirmed) {
        if (confirmed) {
          const deleteResponse = await fetch('/user', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-Authorization': localStorage.getItem('authToken')
            }
          });

          const data = await deleteResponse.json();
          const errorMessage = data.message;

          const success_value = await handleResponseError(deleteResponse, errorMessage)
          if (!success_value) {
            return;
          }
          // Handle success response
          alert('Account successfully deleted.');
          localStorage.removeItem('authToken');
          window.location.href = '/';
        } else {
          // Redirect the user to the main page if user presses "No"
          window.location.href = 'packages.html';
        }
      }
  </script>
</body>
</html>